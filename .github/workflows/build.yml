name: Build project

on:
  push:
    branches:
      - master

jobs:
  build:
    permissions:
      contents: write
      issues: read

    runs-on: ubuntu-latest

    env:
      ZIG_VERSION: 0.13.0

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Zig
        run: |
          wget https://ziglang.org/download/$ZIG_VERSION/zig-linux-x86_64-$ZIG_VERSION.tar.xz
          tar -xf zig-linux-x86_64-$ZIG_VERSION.tar.xz
          mv zig-linux-x86_64-$ZIG_VERSION ~/zig
          echo "$HOME/zig" >> $GITHUB_PATH

      - name: Check Zig version
        run: zig version

      - name: Create bin/ directory
        run: mkdir bin

      - name: Build Windows X86_64
        run: |
          zig cc writeLicense.c main.c -target x86_64-windows-gnu -O2 -o bin/windows_x86_64.exe
          rm -rf bin/windows_x86_64.pdb

      - name: Build Windows ARM64
        run: |
          zig cc writeLicense.c main.c -target aarch64-windows-gnu -O2 -o bin/windows_arm64.exe
          rm -rf bin/windows_arm64.pdb

      - name: Build MacOS ARM64
        run: zig cc writeLicense.c main.c -target aarch64-macos -O2 -o bin/macos_arm64

      - name: Build MacOS X86_64
        run: zig cc writeLicense.c main.c -target x86_64-macos -O2 -o bin/macos_x86_64

      - name: Build Linux ARM64
        run: zig cc writeLicense.c main.c -target aarch64-linux-gnu -O2 -o bin/linux_arm64

      - name: Build Linux X86_64
        run: zig cc writeLicense.c main.c -target x86_64-linux-gnu -O2 -o bin/linux_x86_64

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: bin/

      - name: Get the latest tag
        id: next_version
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
          VERSION=${LAST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          PATCH=$((PATCH + 1))
          NEXT_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT_TAG"
          echo "::set-output name=version::$NEXT_TAG"

      - name: Create tag
        run: git tag ${{ steps.next_version.outputs.version }}

      - name: Push tag
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tags: true

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.next_version.outputs.version }}
          name: ${{ steps.next_version.outputs.version }}
          generate_release_notes: true
          files: bin/*
